!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("underscore"),require("moment")):"function"==typeof define&&define.amd?define(["underscore","moment"],t):"object"==typeof exports?exports.FormulaValue=t(require("underscore"),require("moment")):e.FormulaValue=t(e.underscore,e.moment)}(window,function(__WEBPACK_EXTERNAL_MODULE__3__,__WEBPACK_EXTERNAL_MODULE__6__){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=8)}([function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _underscore=__webpack_require__(3),_underscore2=_interopRequireDefault(_underscore),_moment=__webpack_require__(6),_moment2=_interopRequireDefault(_moment);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var ARRAY_REFERENCE_REGEX=/(.*)\[(@|\*|\d+)]/g,getPath=function(e){if(!e)return[];for(var t=e.split(/\.|::/),n=[],r=function(e,t,r){return n.push(t),"@"!==r&&"*"!==r&&(r=Number(r)),n.push(r),""},a=void 0;t.length>0;)(a=(a=t.shift()).replace(ARRAY_REFERENCE_REGEX,r))&&n.push(a);return n},assignTo=function(e,t,n,r){var a=getPath(t);void 0!==n&&a.push(n);for(var o=void 0;a.length;)o=a.shift(),a.length>0?(e[o]||("number"==typeof a[0]?e[o]=[]:e[o]={}),e=e[o]):e[o]=r},compact=function(e,t){for(var n=getPath(t),r=void 0;n.length;)r=n.shift(),n.length>0?(e[r]||("number"==typeof n[0]?e[r]=[]:e[r]={}),e=e[r]):e[r]=_underscore2.default.compact(e[r])},getDateTimeFormat=function(e){if(!e||"string"!=typeof e)return"";switch(e.length){case 10:return"YYYY-MM-DD";case 19:return"YYYY-MM-DD HH:mm:ss";case 8:return"HH:mm:ss";default:return""}},validateOperation=function(e,t,n){switch(n){case"years":case"months":case"weeks":case"days":if("HH:mm:ss"===e||"HH:mm:ss"===t)return!1;break;case"hours":case"minutes":case"seconds":if(("HH:mm:ss"===e||"HH:mm:ss"===t)&&e!==t)return!1}return!0},evalWithSafeEnvironment=function(){var __defaultSpec="seconds",__availableSpecs={Y:"years",M:"months",W:"weeks",D:"days",h:"hours",m:"minutes",s:"seconds",years:"years",months:"months",weeks:"weeks",days:"days",hours:"hours",minutes:"minutes",seconds:"seconds"},__processStarOperator=function __processStarOperator(array,path){var result=[];if(array&&_underscore2.default.isArray(array)&&array.length)for(var value=void 0,pushNestedElement=function pushNestedElement(nestedElement){value.push(eval("nestedElement"+path))},i=0,len=array.length;i<len;i++){if(_underscore2.default.isArray(array[i]))value=[],array[i].forEach(pushNestedElement);else{value=null;try{value=eval("array[i]"+path)}catch(e){console.warn(e)}}result.push(value)}return result},dateDiff=function(e,t,n){var r=getDateTimeFormat(e),a=getDateTimeFormat(t);return n=__availableSpecs[n]||__defaultSpec,validateOperation(r,a,n)?(e=(0,_moment2.default)(e,r),t=(0,_moment2.default)(t,a),e.diff(t,n)):(console.warn("Invalid inputs at dateDiff."),null)},sum=function(e){var t=0;if(e&&_underscore2.default.isArray(e)&&e.length)for(var n=0,r=e.length;n<r;n++)e[n]&&(t+=e[n]);return t},extract=function(e,t,n){e="string"==typeof e?e:e||"",t=t||",",n=n||0;var r=e.split(t)[n];return isNaN(r)?r:Number(r)},flatten=_underscore2.default.flatten,groupConcat=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:", ";return e.join(t)};function concat(){return Array.prototype.slice.call(arguments).join("")}var count=function(e){return e.length},avg=function(e){var t=sum(e);return e&&_underscore2.default.isArray(e)&&e.length>0&&(t/=e.length),t};return function(formula,data,metaData){return eval(formula)}}.call();exports.default={getPath:getPath,assignTo:assignTo,compact:compact,patterns:{variable:"{{([^}]+)}}",parsedExpression:"\\[\\*(\\d*)\\*\\]",invalidVariable:"\\[(?!(?:@|\\*|\\d+)\\]|[\\.$])|^[^\\[]*\\]|\\][^\\[]*\\]|[\\{\\}]|\\][]|\\][^\\.\\[]"},dataVarName:"data",metaDataVarName:"metaData",evalWithSafeEnvironment:evalWithSafeEnvironment}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=u(n(3)),o=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var i=new RegExp(o.default.patterns.invalidVariable),s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._hasContext=!1,this._hasStar=!1,this._hasAt=!1;for(var n=o.default.getPath(t),r=void 0,a=n.length-1;a>=0;a--)"@"!==(r=n[a])&&"*"!==r?n[a]=r:(this._hasContext=!0,"*"===r?this._hasStar=!0:"@"===r&&(this._hasAt=!0));if(this._path=n,t.indexOf("::")>-1?this._environment=o.default.metaDataVarName:this._environment=o.default.dataVarName,""===t)this._parsedVariable="null";else if(!this._hasContext){for(var u=this._environment,i=0,s=n.length;i<s;i++)u+="['"+n[i]+"']";this._parsedVariable=u}}return r(e,[{key:"parseVariable",value:function(e){return this._parsedVariable||this._parseWithEnvironment(e)}},{key:"_parseWithEnvironment",value:function(e){for(var t=0,n=e.length,r=this._path.length,o=this._path;t<n&&t<r;t++)if("@"===o[t]&&a.default.isNumber(e[t]))o[t]=Number(e[t]);else if(o[t]!==e[t]||"*"===o[t])break;for(;t<r;t++){if("@"===o[t])throw new Error("Context could not fully resolve");"*"===o[t]&&(o[t]="*")}for(var u=void 0,i=!1,s=this._environment,l=0,f=this._path.length;l<f;l++)"*"===(u=this._path[l])?(i?s+='")':i=!0,s="__processStarOperator("+s+',"'):s+="['"+u+"']";return i&&(s+='")'),s}},{key:"hasStar",value:function(){return this._hasStar}},{key:"hasAt",value:function(){return this._hasAt}}],[{key:"isValid",value:function(e){return!i.test(e)}}]),e}();t.default=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=u(n(1)),o=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var i=new RegExp(o.default.patterns.variable,"g"),s=function(){function e(t,n){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._variables=[];for(var o=0,u=t.length;o<u;o++){var s=t[o];n=n.replace(new RegExp(s.pattern,"g"),s.replacement)}var l={};this._parsedExpression=n.replace(i,function(e,t){return a.default.isValid(t)?(l[t]||(l[t]=r._variables.length,r._variables.push(new a.default(t))),"[*"+l[t]+"*]"):"{{"+t+"}}"})}return r(e,[{key:"eval",value:function(){throw new Error("Eval is not implemented")}},{key:"getDependencies",value:function(){throw new Error("GetDependencies is not implemented")}}]),e}();t.default=s},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE__3__},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(2),u=(r=o)&&r.__esModule?r:{default:r};var i=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,[],""));return n.value=e,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,u.default),a(t,[{key:"eval",value:function(){return this.value}}]),t}();t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=u(n(0)),o=u(n(2));u(n(1));function u(e){return e&&e.__esModule?e:{default:e}}var i=[{pattern:"'",replacement:"\\'"}],s=new RegExp(a.default.patterns.variable),l=new RegExp(a.default.patterns.parsedExpression,"g"),f=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,e))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.default),r(t,[{key:"eval",value:function(e,t,n){var r="";try{var o=a.default.getPath(n),u=this._variables.map(function(n){return n.hasStar()?"":a.default.evalWithSafeEnvironment(n.parseVariable(o),e,t)});r=this._parsedExpression.replace(l,function(e,t){return u[parseInt(t)]})}catch(e){console.warn(e)}return r}},{key:"getDependencies",value:function(){return this._variables.map(function(e){return e.split("::").shift()})}}],[{key:"isConcatenatedText",value:function(e){return"string"==typeof e&&s.test(e)>-1}}]),t}();t.default=f},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE__6__},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=u(n(2)),o=(u(n(1)),u(n(0)));function u(e){return e&&e.__esModule?e:{default:e}}var i=[{pattern:"^=",replacement:""},{pattern:"'",replacement:"\\'"}],s=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,e))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),r(t,[{key:"eval",value:function(e,t,n){var r=null;try{var a=o.default.getPath(n),u=this._variables.map(function(e){return e.parseVariable(a)}),i=this._parsedExpression.replace(/\[\*(\d*)\*\]/g,function(e,t){return u[parseInt(t)]});r=o.default.evalWithSafeEnvironment(i,e,t)}catch(e){console.warn(e)}return r}},{key:"getDependencies",value:function(){return this._variables.map(function(e){return e.split("::").shift()})}}],[{key:"isFormula",value:function(e){return"string"==typeof e&&0===e.indexOf("=")}}]),t}();t.default=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=i(n(7)),o=i(n(5)),u=i(n(4));function i(e){return e&&e.__esModule?e:{default:e}}var s=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a.default.isFormula(t)?this.compiledExpression=new a.default(t):o.default.isConcatenatedText(t)?this.compiledExpression=new o.default(t):this.compiledExpression=new u.default(t)}return r(e,[{key:"eval",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return this.compiledExpression.eval(e,t,n)}}],[{key:"isFormulaValue",value:function(e){return a.default.isFormula(e)||o.default.isConcatenatedText(e)}}]),e}();t.default=s}])});
//# sourceMappingURL=FormulaValue.js.map